services:
  # Servi√ßo PHP-FPM (Laravel)
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: pix_app
    volumes:
      - .:/var/www/html
    environment:
      APP_ENV: ${APP_ENV:-local}
      APP_DEBUG: ${APP_DEBUG:-true}
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${MYSQL_DATABASE:-pix}
      DB_USERNAME: ${MYSQL_USER:-pxb}
      DB_PASSWORD: ${MYSQL_PASSWORD:-secret}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      - mysql
      - postgres
      - redis
    networks:
      - pix_net
      - proxy
      - internal


  # Nginx como servidor web
  nginx:
    image: nginx:alpine
    container_name: pix_nginx
    volumes:
      - .:/var/www/html
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    ports:
      - "8080:80"  
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pixseguros.rule=Host(`pixseguros.com.br`,`www.pixseguros.com.br`)"
      - "traefik.http.routers.pixseguros.entrypoints=web"
      - "traefik.http.services.pixseguros.loadbalancer.server.port=80"
    depends_on:
      - app
    networks:
      - pix_net
      - proxy
      - internal

  # Banco MySQL
  mysql:
    image: mysql:8.0
    container_name: pix_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: pix
      MYSQL_USER: pxb
      MYSQL_PASSWORD: secret
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - pix_net
      - proxy
      - internal
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-proot"]
      retries: 3
      timeout: 5s

  # Banco PostgreSQL
  postgres:
    image: postgres:15-alpine
    container_name: pix_postgres
    restart: always
    environment:
      POSTGRES_DB: pix
      POSTGRES_USER: pix
      POSTGRES_PASSWORD: secret
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - pix_net
      - proxy
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pix -d pxb"]
      retries: 3
      timeout: 5s

  # Redis
  redis:
    image: redis:7-alpine
    container_name: pix_redis
    restart: always
    networks:
      - pix_net
      - proxy
      - internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      retries: 3
      timeout: 5s

  # n8n
  n8n:
    image: n8nio/n8n:latest
    container_name: pix_n8n
    restart: always
    environment:
      GENERIC_TIMEZONE: America/Sao_Paulo
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_USER: pix
      DB_POSTGRESDB_PASSWORD: secret
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n-pixseguros.rule=Host(`n8n.pixseguros.com.br`)"
      - "traefik.http.routers.n8n-pixseguros.entrypoints=web"
      - "traefik.http.services.n8n-pixseguros.loadbalancer.server.port=5678"
    depends_on:
      - postgres
    networks:
      - pix_net
      - proxy
      - internal

  # Traefik (reverse proxy)
  traefik:
    image: traefik:v3.0
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "443:443"
      - "8081:8080" # painel Traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - pix_net
      - proxy
      - internal

networks:
  pix_net:
  internal:
    driver: bridge
  proxy:
    external: true

volumes:
  mysql_data:
  postgres_data:
  redis_data:





